const a={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"9c249efa-f885-4658-8591-7dd611d2a961","Content-Type":"application/json"}},p=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),Q=()=>fetch(`${a.baseUrl}/users/me`,{headers:a.headers}).then(p),T=()=>fetch(`${a.baseUrl}/cards`,{headers:a.headers}).then(p),X=({name:e,about:t})=>fetch(`${a.baseUrl}/users/me`,{method:"PATCH",headers:a.headers,body:JSON.stringify({name:e,about:t})}).then(p),Y=({avatar:e})=>fetch(`${a.baseUrl}/users/me/avatar`,{method:"PATCH",headers:a.headers,body:JSON.stringify({avatar:e})}).then(p),Z=({name:e,link:t})=>fetch(`${a.baseUrl}/cards`,{method:"POST",headers:a.headers,body:JSON.stringify({name:e,link:t})}).then(p),ee=e=>fetch(`${a.baseUrl}/cards/${e}`,{method:"DELETE",headers:a.headers}).then(p),te=(e,t)=>fetch(`${a.baseUrl}/cards/${e}/likes`,{method:t?"DELETE":"PUT",headers:a.headers}).then(o=>p(o)),oe=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),A=(e,{onPreviewPicture:t,onLikeIcon:o,onDeleteCard:n,onInfoButton:r},s)=>{const c=oe(),l=c.querySelector(".card__like-button"),d=c.querySelector(".card__control-button_type_delete"),v=c.querySelector(".card__image"),I=c.querySelector(".card__like-count"),B=c.querySelector(".card__control-button_type_info");return v.src=e.link,v.alt=e.name,c.querySelector(".card__title").textContent=e.name,I.textContent=e.likes.length,c.dataset.cardId=e._id,B.dataset.id=e._id,e.likes.some(K=>K._id===s)&&l.classList.add("card__like-button_is-active"),o&&l.addEventListener("click",()=>o(l,I,c.dataset.cardId)),e.owner&&e.owner._id===s?d.addEventListener("click",()=>{n(c,e._id)}):d.remove(),t&&v.addEventListener("click",()=>t({name:e.name,link:e.link})),r&&B.addEventListener("click",()=>{r(e._id)}),c},M=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");i(t)}},_=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",M)},i=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",M)},ne=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{i(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&i(e)})};function w(e,t,o,n){let r=e.querySelector("#"+t.id+"-error");t.classList.add(n.inputErrorClass),r.textContent=o,r.classList.add(n.errorClass)}function D(e,t,o){let n=e.querySelector("#"+t.id+"-error");t.classList.remove(o.inputErrorClass),n.classList.remove(o.errorClass),n.textContent=""}function re(e,t,o){t.validity.valid?D(e,t,o):t.validity.patternMismatch&&t.hasAttribute("data-error-message")?w(e,t,t.dataset.errorMessage,o):w(e,t,t.validationMessage,o)}function ce(e){return e.some(function(t){return!t.validity.valid})}function F(e,t){e.classList.add(t.inactiveButtonClass),e.disabled=!0}function ae(e,t){e.classList.remove(t.inactiveButtonClass),e.disabled=!1}function U(e,t,o){ce(e)?F(t,o):ae(t,o)}function le(e,t){let o=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);U(o,n,t),o.forEach(function(r){r.addEventListener("input",function(){re(e,r,t),U(o,n,t)})})}function b(e,t){const o=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);o.forEach(function(r){D(e,r,t),r.setCustomValidity("")}),e.reset(),F(n,t)}function se(e){Array.from(document.querySelectorAll(e.formSelector)).forEach(function(o){le(o,e)})}const h={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};se(h);const $=document.querySelector(".places__list"),S=document.querySelector(".popup_type_edit"),f=S.querySelector(".popup__form"),N=f.querySelector(".popup__input_type_name"),W=f.querySelector(".popup__input_type_description"),q=document.querySelector(".popup_type_new-card"),u=q.querySelector(".popup__form"),ie=u.querySelector(".popup__input_type_card-name"),ue=u.querySelector(".popup__input_type_url"),L=document.querySelector(".popup_type_image"),P=L.querySelector(".popup__image"),pe=L.querySelector(".popup__caption"),de=document.querySelector(".profile__edit-button"),_e=document.querySelector(".profile__add-button"),k=document.querySelector(".profile__title"),g=document.querySelector(".profile__description"),E=document.querySelector(".profile__image"),H=document.querySelector(".popup_type_edit-avatar"),m=H.querySelector(".popup__form"),me=m.querySelector(".popup__input"),x=document.querySelector(".popup_type_remove-card"),O=x.querySelector(".popup__form");let V=null,j=null;const fe=document.getElementById("popup-info-definition-template").content,J=({name:e,link:t})=>{P.src=t,P.alt=e,pe.textContent=e,_(L)},ye=e=>{e.preventDefault();const t=f.querySelector(".popup__button");t.textContent="Сохранение...",X({name:N.value,about:W.value}).then(o=>{k.textContent=o.name,g.textContent=o.about,i(S)}).catch(o=>{console.log(o)}).finally(()=>{t.textContent="Сохранить"})},he=e=>{e.preventDefault();const t=m.querySelector(".popup__button");t.textContent="Сохранение...",Y({avatar:me.value}).then(o=>{E.style.backgroundImage=`url(${o.avatar})`,i(S)}).catch(o=>{console.log(o)}).finally(()=>{t.textContent="Сохранить"})},Se=e=>{e.preventDefault();const t=u.querySelector(".popup__button");t.textContent="Создание...",Z({name:ie.value,link:ue.value}).then(o=>{$.prepend(A(o,{onPreviewPicture:J,onLikeIcon:(n,r,s)=>z(n,r,s),onDeleteCard:(n,r)=>{R(n,r)},onInfoButton:G},C)),u.reset(),i(q)}).catch(o=>{console.log(o)}).finally(()=>{t.textContent="Создать"})},R=(e,t)=>{V=e,j=t,_(x)},ve=e=>{e.preventDefault();const t=O.querySelector(".popup__button");t.textContent="Удаление...",ee(j).then(()=>{V.remove(),i(x)}).catch(o=>{console.log(o)}).finally(()=>{t.textContent="Да"})},z=(e,t,o)=>{const n=e.classList.contains("card__like-button_is-active");e.disabled=!0,te(o,n).then(r=>{t.textContent=r.likes.length,e.classList.toggle("card__like-button_is-active")}).catch(r=>{console.log(r)}).finally(()=>{e.disabled=!1})},Ce=e=>e.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"}),y=(e,t)=>{const o=fe.cloneNode(!0);return o.querySelector(".popup__info-term").textContent=e,o.querySelector(".popup__info-description").textContent=t,o},be=e=>{const t=document.getElementById("popup-info-user-preview-template");if(!t){console.error("Шаблон не найден");const n=document.createElement("li");return n.textContent=e?.name||"—",n.classList.add("popup__list-item","popup__list-item_type_name"),n}if(!e||!e.name){const n=document.createElement("li");return n.textContent="—",n.classList.add("popup__list-item","popup__list-item_type_name"),n}const o=t.content.cloneNode(!0).children[0];return o.textContent=e.name,o},G=e=>{const t=document.querySelector(".popup_type_info"),o=t.querySelector(".popup__info"),n=t.querySelector(".popup__list"),r=t.querySelector(".popup__title"),s=t.querySelector(".popup__text");r.textContent="",o.innerHTML="",n.innerHTML="",T().then(c=>{const l=c.find(d=>d._id===e);r.textContent="Информация о карточке",o.append(y("Описание:",l.name)),o.append(y("Дата создания:",Ce(new Date(l.createdAt)))),o.append(y("Владелец:",l.owner.name)),o.append(y("Количество лайков:",l.likes.length)),l.likes.length>0&&(s.textContent="Лайкнули:",l.likes.forEach(d=>{n.append(be(d))})),_(t)}).catch(c=>{console.log(c)})};f.addEventListener("submit",ye);u.addEventListener("submit",Se);m.addEventListener("submit",he);de.addEventListener("click",()=>{N.value=k.textContent,W.value=g.textContent,b(f,h),_(S)});E.addEventListener("click",()=>{m.reset(),b(m,h),_(H)});_e.addEventListener("click",()=>{u.reset(),b(u,h),_(q)});O.addEventListener("submit",ve);const qe=document.querySelectorAll(".popup");qe.forEach(e=>{ne(e)});let C;Promise.all([T(),Q()]).then(([e,t])=>{C=t._id,k.textContent=t.name,g.textContent=t.about,E.style.backgroundImage=`url(${t.avatar})`,e.forEach(o=>{$.append(A(o,{onPreviewPicture:J,onLikeIcon:(n,r,s)=>z(n,r,s),onDeleteCard:(n,r)=>{R(n,r)},onInfoButton:G},C))})}).catch(e=>{console.log(e)});
